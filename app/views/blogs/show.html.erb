<script type="text/javascript">

<% if @blog.posts.blank? && Delayed::Job.find_by(id: @blog.job_id) != nil %>
	 

	 
	 //$("#queue-number").text("You are "  + "in line");
	 var interval;
	 
  interval = setInterval(function(){
    $.ajax({
      url: '/progress-job/' + <%= @blog.job_id %>,
      success: function(job){

        var stage, progress;
        progress = job.progress_current / job.progress_max * 100;
        
        // In job stage
        if (progress !== 0){
	    	stage = job.progress_stage;
	    	if (stage != null){
	    		$('.progress-status').text(stage);
	    	}
	    	
          $('.progress-bar').css('width', progress + '%').text(progress + '%');
        }
      },
      error: function(){
      	location.reload(true);
        // Job is no loger in database which means it finished successfuly
        $('.progress').removeClass('active');
        $('.progress-bar').css('width', '100%').text('100%');
        $('.progress-status').text('Successfully imported!');
        clearInterval(interval);
      }
    })
    $.ajax("<%= position_path(@blog.id) %>")
	 	.done(function(number){
	 		$('#queue-number').text(number);
	 	})
	 	.fail(function(){
	 	});
  },2000);
<% end %>
</script>

<h1><%= @blog.name %></h1>
<% if @blog.posts.present? %>
		<table class="table center">
			<tr>
				<th class="col-xs-1">Rank</th>
				<th class="col-xs-1">Notes</th>
				<th class="col-xs-9">Post</th>
				<th class="col-xs-1">Date</th>
			</tr>
			<% @blog.posts.each_with_index do |post, index|%>
				<tr>
					<td><%= index + 1 %></td>
					<td><%= post["note_count"] %></td>
					  <td>
					  
					  
					  		<% if post["type"] == "photo" %>
					  			<%= content_tag :a, href: post["short_url"], class: "thumbnail", target: "_blank" do %>
					  				<%= content_tag :img, nil, src: post["photos"][0]["alt_sizes"][2]["url"] %>
					  			<% end %>
					  		<% elsif post["type"] =="text" %>

						  		<%= content_tag :p do %>
						  			<% if post["title"].present? %>
						  				<%= content_tag :a, href: post["short_url"], class: "thumbnail", target: "_blank" do %>
						  					<%= post["title"] %>
					  					<% end %>
					  				<% else %>
						  				<%= post["body"].html_safe %>
						  				<%= content_tag :a, "link to text post", href: post["short_url"], class: "thumbnail", target: "_blank" %>
					  				<% end %>
					  			<% end %>
					  		<% elsif post["type"] == "video" %>
					  			<% if post["thumbnail_url"].present? %>
					  				<%= content_tag :a, href: post["short_url"], class: "thumbnail", target: "_blank" do %>
					  					<%= content_tag :img, nil, src: post["thumbnail_url"] %>
				  					<% end %>
				  				<% else %>
					  				<%= post["caption"].html_safe %>
					  				<%= content_tag :a, "link to video post", href: post["short_url"], class: "thumbnail", target: "_blank" %>
				  				<% end %>
					  		<% elsif post["type"] == "audio" %>
					  			<% if post["thumbnail_url"].present? %>
					  				<%= content_tag :a, href: post["short_url"], class: "thumbnail", target: "_blank" do %>
					  					<%= content_tag :img, nil, src: post["album_art"] %>
					  				<% end %>
				  				<% else %>
					  				<%= post["caption"].html_safe %>
					  				<%= content_tag :a, "link to audio post", href: post["short_url"], class: "thumbnail", target: "_blank" %>
				  				<% end %>
				  			<% elsif post["type"] == "quote" %>
				  				<%= content_tag :a, href: post["short_url"], class: "thumbnail", target: "_blank" do %>
				  				 	<%= content_tag :p, post["text"] %>
				  				 <% end %>
				  			 <% elsif post["type"] == "link" %>
				  			 	<%= content_tag :a, href: post["short_url"], class: "thumbnail", target: "_blank" do %>
				  			 		<%= content_tag :p, post["title"] %>
				  			 	<% end %>
				  			 <% elsif post["type"] == "chat" %>
					  			 	<% if post["title"].present? %>
							  				<%= content_tag :h5, post["title"] %>
				  					<% end %>
				  					<%= content_tag :p, post["body"].html_safe %>
				  					<%= content_tag :a, "link to chat post", href: post["short_url"], class: "thumbnail", target: "_blank" %>
				  			 <% elsif post["type"] == "answer" %>
				  			 	<%= content_tag :h5, post["question"] %>
				  			 	<%= content_tag :p, post["answer"].html_safe %>
				  			 	<%= content_tag :a, "link to answer post", href: post["short_url"], class: "thumbnail", target: "_blank" %>
					  		<% end %>
						
					  </td>
					 <td><%= Time.at(post["timestamp"]).strftime('%m/%d/%Y') %></td>
				</tr>
			<% end %>
		</table>
	<% else %>
	 <h2>You are <span id="queue-number"></span> in line</h2>
<div class="progress-status">Please be patient...</div>
<div class="progress">
  <div class="progress-bar col-xs-12" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2.5em;">
    0.00%
  </div>
</div>
	<% end %>